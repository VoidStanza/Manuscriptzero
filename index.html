<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE VAULT | ARCHIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Lora:ital,wght@0,400;1,400&family=Montserrat:wght@300;400;600&display=swap');
        
        :root { --bg: #0a0a0b; --accent: #d4af37; }
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; box-sizing: border-box; }
        
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); color: #e2e2e2; margin: 0; overflow-x: hidden; }
        .serif { font-family: 'Playfair Display', serif; }
        .reading-font { font-family: 'Lora', serif; line-height: 1.9; }

        /* ELONGATED BOXES */
        .story-card-container { aspect-ratio: 2 / 3; width: 100%; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.05); background: #111; transition: all 0.5s ease; }
        .story-card-container img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); transition: 0.8s ease; }
        .group:hover .story-card-container img { filter: grayscale(0%); transform: scale(1.05); }

        /* SCANNER */
        #scanner-core { width: 120px; height: 120px; border-radius: 50%; border: 1px solid rgba(212, 175, 55, 0.2); display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        #laser { position: absolute; width: 140px; height: 1px; background: var(--accent); box-shadow: 0 0 12px var(--accent); opacity: 0; top: 0; pointer-events: none; }
        .scanning #laser { opacity: 1; animation: scanLine 2s infinite ease-in-out; }
        @keyframes scanLine { 0% { top: 0%; } 100% { top: 100%; } }

        .hidden { display: none !important; }
        .access-granted-anim { animation: portalExit 0.8s forwards; }
        @keyframes portalExit { to { opacity: 0; transform: scale(1.1); filter: blur(20px); } }
        #progress-bar { position: fixed; top: 0; left: 0; height: 2px; background: var(--accent); z-index: 100; transition: width 0.2s; }

        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="progress-bar" style="width: 0%"></div>

    <div id="loading-screen" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black">
        <div id="scanner-core" onmousedown="startScan(event)" onmouseup="stopScan()" ontouchstart="startScan(event)" ontouchend="stopScan()">
            <div id="laser"></div>
            <div class="w-4 h-4 bg-[#d4af37] rounded-full animate-pulse shadow-[0_0_15px_#d4af37]"></div>
        </div>
        <div id="scan-status" class="serif text-[#d4af37] tracking-[0.5em] text-[10px] uppercase mt-12">Hold to Initialize</div>
        <div id="progress-text" class="text-[8px] text-gray-700 mt-3 font-mono uppercase tracking-[0.3em]">Identity Check Required</div>
    </div>

    <div id="main-content" class="hidden">
        <nav id="top-nav" class="fixed top-0 left-0 right-0 p-6 flex justify-between items-center bg-black/80 backdrop-blur-lg z-50 border-b border-white/5 transition-transform duration-500">
            <h2 class="serif text-2xl cursor-pointer text-[#d4af37]" onclick="showHome()">V.</h2>
        </nav>

        <main class="p-6 pt-32 max-w-5xl mx-auto">
            <section id="home-page">
                <div class="mb-16">
                    <h1 class="serif text-5xl mb-2 text-[#d4af37]">The Vault</h1>
                    <p class="text-[10px] uppercase tracking-[0.4em] text-gray-600">Authorized Personnel Only</p>
                </div>
                <div id="story-grid" class="grid grid-cols-2 md:grid-cols-3 gap-10"></div>
            </section>

            <section id="detail-page" class="hidden">
                <button onclick="showHome()" class="text-[9px] uppercase tracking-[0.3em] text-gray-500 mb-12 border-b border-gray-800 pb-1">← Return to Gallery</button>
                
                <div id="detail-view">
                    <div class="flex flex-col md:flex-row gap-12">
                        <div id="detail-cover" class="w-full md:w-1/3 aspect-[2/3] bg-cover bg-center border border-white/10 grayscale"></div>
                        <div class="flex-1">
                            <h2 id="detail-title" class="serif text-5xl mb-6 text-[#d4af37]"></h2>
                            <p id="detail-synopsis" class="reading-font text-xl text-gray-400 italic mb-10"></p>
                            <button onclick="startReading()" class="w-full py-5 bg-[#d4af37] text-black font-bold uppercase text-[11px] tracking-[0.3em]">Enter the archive</button>
                        </div>
                    </div>
                </div>

                <div id="reading-view" class="hidden max-w-2xl mx-auto">
                    <h2 id="reading-title" class="serif text-3xl text-center mb-20 text-[#d4af37]"></h2>
                    <div id="full-text" class="reading-font text-lg text-gray-300 space-y-10 mb-20"></div>
                    
                    <div class="py-16 border-t border-white/5 flex flex-col items-center">
                        <button onclick="handleLike()" id="like-btn" class="text-5xl transition-transform active:scale-150">♡</button>
                        <span id="like-count" class="text-[10px] text-[#d4af37] mt-4 tracking-[0.3em] uppercase">0 Likes</span>
                    </div>

                    <div class="pt-16 border-t border-white/5">
                        <h3 class="serif text-2xl text-[#d4af37] mb-8">Marginalia</h3>
                        <textarea id="comment-input" class="w-full bg-[#111] border border-white/10 p-5 text-white mb-4 focus:border-[#d4af37] outline-none" rows="4" placeholder="Enter encrypted message..."></textarea>
                        <button onclick="postComment()" class="w-full py-4 bg-transparent border border-[#d4af37] text-[#d4af37] text-[10px] font-bold uppercase tracking-widest hover:bg-[#d4af37] hover:text-black transition-all">Preserved in the margins</button>
                        
                        <div id="comment-list" class="mt-20 space-y-12 pb-32"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const stories = [
            { id: 1, title: "Horizon", synopsis: "The perfect son is a masterpiece of a lie.", text: "He sits at the edge of the living room, a statue of filial piety.", cover: "https://i.pinimg.com/736x/a3/a3/08/a3a3084fa4e3ba568560114e137ba5aa.jpg" },
            { id: 2, title: "Anamnesis", synopsis: "The archives are hungry.", text: `<div class='font-mono bg-black/40 p-8 rounded border border-[#d4af37]/20 text-sm'><p class='text-[#d4af37] mb-6'>INT. MEDICAL COLLEGE - RESEARCH LAB - NIGHT</p>...[Content Loaded]...<br><br><span class='text-red-500 font-bold'>ANAMNESIS_004 - FILE READY FOR NEXT SUBJECT</span></div>`, cover: "https://i.pinimg.com/1200x/dc/0d/c1/dc0dc15c13dcfe322b098796162b2a39.jpg" }
        ];

        const sbClient = supabase.createClient('https://iakkxwghbczalryylqzg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlha2t4d2doYmN6YWxyeXlscXpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5Nzk1NzcsImV4cCI6MjA4NjU1NTU3N30._KXFa9Ohst1P-vA8L6Eyd3B8qdPCTSbPHV0_kO3OkVc');

        let activeStory = null, scanTimer = null, scanProgress = 0, isAuthorized = false, lastScroll = 0;

        function startScan(e) {
            if (e) e.preventDefault();
            if (isAuthorized) return;
            document.body.classList.add('scanning');
            clearInterval(scanTimer);
            scanTimer = setInterval(() => {
                scanProgress += 2;
                document.getElementById('progress-text').innerText = `DECRYPTING: ${scanProgress}%`;
                if (scanProgress >= 100) { clearInterval(scanTimer); isAuthorized = true; sessionStorage.setItem('vault_authorized', 'true'); completeAuth(); }
            }, 30);
        }

        function stopScan() {
            if (isAuthorized) return;
            clearInterval(scanTimer);
            scanProgress = 0;
            document.body.classList.remove('scanning');
            document.getElementById('progress-text').innerText = "SYSTEM: LOCKED";
        }

        function completeAuth() {
            document.getElementById('scan-status').innerText = "ACCESS GRANTED";
            setTimeout(() => {
                const loader = document.getElementById('loading-screen');
                loader.classList.add('access-granted-anim');
                setTimeout(() => { loader.style.display = 'none'; document.getElementById('main-content').classList.remove('hidden'); renderStories(); }, 600);
            }, 400);
        }

        function renderStories() {
            document.getElementById('story-grid').innerHTML = stories.map(s => `
                <div onclick="showStory(${s.id})" class="group cursor-pointer">
                    <div class="story-card-container"><img src="${s.cover}"></div>
                    <h4 class="serif text-sm mt-4 uppercase tracking-tighter text-gray-500 group-hover:text-[#d4af37] transition-colors">${s.title}</h4>
                </div>
            `).join('');
        }

        async function showStory(id) {
            activeStory = stories.find(s => s.id === id);
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('detail-page').classList.remove('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
            document.getElementById('reading-view').classList.add('hidden');
            
            document.getElementById('detail-title').innerText = activeStory.title;
            document.getElementById('detail-synopsis').innerText = activeStory.synopsis;
            document.getElementById('detail-cover').style.backgroundImage = `url(${activeStory.cover})`;
            
            // Clear current view and load history immediately
            document.getElementById('comment-list').innerHTML = "<p class='text-[8px] uppercase tracking-widest text-gray-600'>Retrieving history...</p>";
            
            const { data } = await sbClient.from('stories_meta').select('likes').eq('story_id', id).single();
            document.getElementById('like-count').innerText = `${data ? data.likes : 0} LIKES`;
            
            await fetchComments(); // Ensure comments load on story selection
            window.scrollTo(0,0);
        }

        function showHome() { 
            document.getElementById('detail-page').classList.add('hidden'); 
            document.getElementById('home-page').classList.remove('hidden'); 
            window.scrollTo(0,0); 
        }

        async function startReading() {
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('reading-view').classList.remove('hidden');
            document.getElementById('reading-title').innerText = activeStory.title;
            document.getElementById('full-text').innerHTML = activeStory.text;
            window.scrollTo(0,0);
        }

        async function handleLike() {
            const { data: cur } = await sbClient.from('stories_meta').select('likes').eq('story_id', activeStory.id).single();
            let newCount = (cur ? cur.likes : 0) + 1;
            await sbClient.from('stories_meta').upsert({ story_id: activeStory.id, likes: newCount }, { onConflict: 'story_id' });
            document.getElementById('like-count').innerText = `${newCount} LIKES`;
        }

        async function postComment() {
            const input = document.getElementById('comment-input');
            const val = input.value.trim();
            if(!val) return;
            
            const { error } = await sbClient.from('comments').insert([{ story_id: activeStory.id, content: val }]);
            if(!error) {
                input.value = "";
                await fetchComments(); // Reload history after posting
            }
        }

        async function fetchComments() {
            // Fetch everything for the active story ID
            const { data, error } = await sbClient
                .from('comments')
                .select('*')
                .eq('story_id', activeStory.id)
                .order('created_at', { ascending: false });

            const list = document.getElementById('comment-list');
            
            if (error) {
                list.innerHTML = "<p class='text-red-900 text-[8px]'>HISTORY ACCESS DENIED</p>";
                return;
            }

            if (data && data.length > 0) {
                list.innerHTML = data.map(c => `
                    <div class="border-l border-[#d4af37]/20 pl-6 py-4 fade-in">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[8px] text-gray-600 uppercase tracking-[0.3em] font-mono">Ref: ARCHIVE_ID_${c.id.toString().slice(-3)}</p>
                            <p class="text-[8px] text-gray-700 font-mono">${new Date(c.created_at).toLocaleDateString()}</p>
                        </div>
                        <p class="reading-font text-gray-300 text-sm leading-relaxed">${c.content}</p>
                    </div>
                `).join('');
            } else {
                list.innerHTML = "<p class='text-gray-700 text-[8px] uppercase tracking-widest'>No prior transmissions found.</p>";
            }
        }

        window.onscroll = () => {
            const cur = window.scrollY;
            const nav = document.getElementById('top-nav');
            cur > lastScroll && cur > 100 ? nav.classList.add('nav-hidden') : nav.classList.remove('nav-hidden');
            lastScroll = cur;
            const h = document.documentElement.scrollHeight - window.innerHeight;
            if(h > 0) document.getElementById('progress-bar').style.width = `${(cur / h) * 100}%`;
        };

        window.onload = () => { 
            if (sessionStorage.getItem('vault_authorized') === 'true') { 
                isAuthorized = true; 
                document.getElementById('loading-screen').style.display = 'none'; 
                document.getElementById('main-content').classList.remove('hidden'); 
                renderStories(); 
            } 
        };
    </script>
</body>
</html>
